<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fdproject.mapper.DrugMapper">
    <resultMap id="drug" type="DrugDTO">
        <result property="drugNo" column="drug_no"/>
        <result property="drugName" column="drug_name"/>
        <result property="manufacturer" column="manufacturer"/>
        <result property="basis" column="basis"/>
        <result property="effect" column="effect"/>
        <result property="method" column="method"/>
        <result property="warning1" column="warning1"/>
        <result property="warning2" column="warning2"/>
        <result property="sideEffect" column="side_effect"/>
        <result property="storage" column="storage"/>
        <result property="houseYn" column="HOUSE_YN"/>
        <result property="imgFile" column="img_file"/>
        <result property="keyword" column="keyword"/>
    </resultMap>

    <sql id="drugColumns">
        d.DRUG_NO,
        d.DRUG_NAME,
        d.MANUFACTURER,
        d.BASIS,
        d.EFFECT,
        d.METHOD,
        d.WARNING1,
        d.WARNING2,
        d.SIDE_EFFECT,
        d.STORAGE,
        d.HOUSE_YN,
        d.IMG_FILE,
        d.KEYWORD
    </sql>

    <sql id="riskDrug">
        <if test="params != null and params != ''">
            <choose>
                <when test="takeYn != null and takeYn != ''">
                    <choose>
                        <when test='takeYn.equals("Y")'>
                            and NOT REGEXP_LIKE(temp.WARNING, #{params})
                        </when>
                        <when test='takeYn.equals("N")'>
                            and REGEXP_LIKE(temp.WARNING, #{params})
                        </when>
                    </choose>
                </when>
            </choose>
        </if>
    </sql>

    <select id="drugList" parameterType="DrugDTO" resultMap="drug">
        <include refid="CommonMapper.pagingHeader"/>
        select
        temp.DRUG_NO,
        temp.DRUG_NAME,
        temp.MANUFACTURER,
        temp.BASIS,
        temp.EFFECT,
        temp.METHOD,
        temp.WARNING1,
        temp.WARNING2,
        temp.SIDE_EFFECT,
        temp.STORAGE,
        temp.HOUSE_YN,
        temp.IMG_FILE,
        temp.KEYWORD
        from
        (select
        <include refid="drugColumns"/>
        ,d.WARNING1 || d.WARNING2 WARNING
        from
        drugs d) temp
        where
        1=1
        <include refid="riskDrug"/>
        <include refid="CommonMapper.search_o"/>
        order by drug_name asc
        <include refid="CommonMapper.pagingFooter"/>
    </select>

    <select id="selectDrugTotalCount" parameterType="DrugDTO" resultType="int">
        select
        COUNT(<![CDATA[*]]>)
        from
        (select
        <include refid="drugColumns"/>
        ,d.WARNING1 || d.WARNING2 WARNING
        from
        drugs d) temp
        where
        1=1
        <include refid="riskDrug"/>
	    <include refid="CommonMapper.search_o"/>
    </select>

    <select id="getUserDrug" parameterType="UserDrugDTO" resultType="UserDrugDTO">
        select
        drug_name as drugName
        from USER_DRUGS
        where USER_ID = #{userId}
    </select>

    <select id="selectKeywords" resultType="String">
        select
        keyword
        from
        drugs
        where drug_name in
        <foreach collection="userDrugList" item="item" index="index" open="(" separator="," close=")">
            #{item.drugName}
        </foreach>
    </select>

    <select id="housedrugList" parameterType="DrugDTO" resultMap="drug">
        select
        <include refid="drugColumns"/>
        from
        drugs
        where
        HOUSE_YN = 'Y'
        order by drug_name asc
    </select>
    

    <select id="getDrugDetail" parameterType="DrugDTO" resultMap="drug">
        select
        <include refid="drugColumns"/>
        from
        drugs d
        where
        1=1
        and d.DRUG_NO = #{drugNo}
    </select>
</mapper>